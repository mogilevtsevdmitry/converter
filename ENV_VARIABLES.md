# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —É–¥–æ–±–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` –≤ `.env`:
   ```bash
   cp .env.example .env
   ```

2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:
   ```bash
   docker-compose down
   docker-compose up -d
   ```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

### üìä PostgreSQL

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `POSTGRES_USER` | `postgres` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å PostgreSQL |
| `POSTGRES_PASSWORD` | `postgres` | –ü–∞—Ä–æ–ª—å PostgreSQL |
| `POSTGRES_DB` | `converter` | –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö |
| `POSTGRES_PORT` | `5455` | –í–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç PostgreSQL |
| `DATABASE_MAX_OPEN_CONNS` | `25` | –ú–∞–∫—Å. –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π |
| `DATABASE_MAX_IDLE_CONNS` | `5` | –ú–∞–∫—Å. idle –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π |

### üóÑÔ∏è MinIO (S3)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `MINIO_ROOT_USER` | `minioadmin` | Root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å MinIO |
| `MINIO_ROOT_PASSWORD` | `minioadmin` | Root –ø–∞—Ä–æ–ª—å MinIO |
| `MINIO_PORT` | `9000` | API –ø–æ—Ä—Ç MinIO |
| `MINIO_CONSOLE_PORT` | `9001` | Web –∫–æ–Ω—Å–æ–ª—å MinIO |
| `S3_REGION` | `us-east-1` | –†–µ–≥–∏–æ–Ω S3 |
| `S3_BUCKET_OUTPUT` | `converted` | Bucket –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ |
| `S3_USE_SSL` | `false` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSL |

### ‚è±Ô∏è Temporal

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `TEMPORAL_PORT` | `7233` | –ü–æ—Ä—Ç Temporal —Å–µ—Ä–≤–µ—Ä–∞ |
| `TEMPORAL_UI_PORT` | `8088` | –ü–æ—Ä—Ç Temporal UI |
| `TEMPORAL_NAMESPACE` | `default` | Namespace –¥–ª—è workflow |
| `TEMPORAL_TASK_QUEUE` | `video-conversion` | –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á |

### üåê API

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `API_PORT` | `8080` | –ü–æ—Ä—Ç HTTP API |
| `API_READ_TIMEOUT` | `30s` | –¢–∞–π–º–∞—É—Ç —á—Ç–µ–Ω–∏—è |
| `API_WRITE_TIMEOUT` | `30s` | –¢–∞–π–º–∞—É—Ç –∑–∞–ø–∏—Å–∏ |

### ‚öôÔ∏è Worker

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `WORKER_PORT` | `9091` | –ü–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫ worker |
| `WORKER_CPU_LIMIT` | `1.5` | **–õ–∏–º–∏—Ç CPU (—è–¥—Ä–∞)** |
| `WORKER_MEMORY_LIMIT` | `4G` | **–õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏** |
| `WORKDIR_ROOT` | `/work` | –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è |
| `MAX_PARALLEL_JOBS` | `1` | **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á** |
| `MAX_PARALLEL_FFMPEG` | `1` | **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö ffmpeg –ø—Ä–æ—Ü–µ—Å—Å–æ–≤** |
| `MAX_PARALLEL_UPLOADS` | `10` | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫ –≤ S3 |
| `ENABLE_GPU` | `false` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPU (NVIDIA) |

### üé¨ –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `ENCODING_LEGACY_TIER` | `true` | H.264/AAC/TS (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å) |
| `ENCODING_MODERN_TIER` | `true` | H.265/AAC/fMP4 (—ç–∫–æ–Ω–æ–º–∏—è 40%) |
| `HLS_SEGMENT_TYPE` | `fmp4` | –¢–∏–ø —Å–µ–≥–º–µ–Ω—Ç–æ–≤: `ts` –∏–ª–∏ `fmp4` |
| `H265_PRESET` | `slower` | **Preset H.265**: ultrafast...veryslow |
| `H265_CRF` | `28` | **CRF H.265** (0-51, –º–µ–Ω—å—à–µ=–ª—É—á—à–µ) |

#### –î–æ—Å—Ç—É–ø–Ω—ã–µ H.265 Presets (–æ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –∫ –º–µ–¥–ª–µ–Ω–Ω–æ–º—É):
- `ultrafast` - –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ, –±–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä, –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
- `superfast` - –±—ã—Å—Ç—Ä–æ, –±–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä
- `veryfast` - –±—ã—Å—Ç—Ä–æ
- `faster` - –±—ã—Å—Ç—Ä–µ–µ —Å—Ä–µ–¥–Ω–µ–≥–æ
- `fast` - –±—ã—Å—Ç—Ä–µ–µ
- `medium` - —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é FFmpeg)
- `slow` - –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –ª—É—á—à–µ –∫–∞—á–µ—Å—Ç–≤–æ
- `slower` - **—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è MacBook** - –º–µ–¥–ª–µ–Ω–Ω–æ, –æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –Ω–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
- `veryslow` - –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ

### üì∫ HLS

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `HLS_SEGMENT_DURATION_SEC` | `4` | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ–≥–º–µ–Ω—Ç–∞ (—Å–µ–∫) |
| `HLS_ENABLE_ENCRYPTION` | `false` | –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ HLS (AES-128) |
| `HLS_KEY_URL` | - | URL –¥–ª—è –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è |

### üñºÔ∏è –ü—Ä–µ–≤—å—é (Thumbnails)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `THUMB_MAX_FRAMES` | `200` | –ú–∞–∫—Å. –∫–∞–¥—Ä–æ–≤ –¥–ª—è –ø—Ä–µ–≤—å—é |

### üîê DRM

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `DRM_ENABLED` | `false` | –í–∫–ª—é—á–∏—Ç—å DRM |
| `DRM_PROVIDER` | `widevine` | widevine/fairplay/playready/all |
| `SHAKA_PACKAGER_PATH` | `packager` | –ü—É—Ç—å –∫ Shaka Packager |

**Widevine:**
- `DRM_WIDEVINE_KEY_ID`
- `DRM_WIDEVINE_KEY`
- `DRM_WIDEVINE_PSSH`

**FairPlay:**
- `DRM_FAIRPLAY_KEY_URL`
- `DRM_FAIRPLAY_CERT_PATH`
- `DRM_FAIRPLAY_IV`

**PlayReady:**
- `DRM_PLAYREADY_KEY_ID`
- `DRM_PLAYREADY_KEY`
- `DRM_PLAYREADY_LA_URL`

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `PROMETHEUS_PORT` | `9090` | –ü–æ—Ä—Ç Prometheus |
| `GRAFANA_PORT` | `3000` | –ü–æ—Ä—Ç Grafana |
| `GRAFANA_ADMIN_PASSWORD` | `admin` | –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ Grafana |

### üîÑ Retry

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `RETRY_COUNT` | `3` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–æ–≤ |
| `RETRY_BASE_DELAY_MS` | `1000` | –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–º—Å) |
| `RETRY_MAX_DELAY_MS` | `30000` | –ú–∞–∫—Å. –∑–∞–¥–µ—Ä–∂–∫–∞ (–º—Å) |

### üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------------|----------|
| `LOG_LEVEL` | `info` | debug/info/warn/error |
| `LOG_FORMAT` | `json` | json/text |

## üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è MacBook Air M4

–î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–≥—Ä–µ–≤–∞ (95¬∞C ‚Üí 60-75¬∞C):

```bash
# .env
WORKER_CPU_LIMIT=1.5          # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å CPU
WORKER_MEMORY_LIMIT=4G        # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å
MAX_PARALLEL_JOBS=1           # –û–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –∑–∞ —Ä–∞–∑
MAX_PARALLEL_FFMPEG=1         # –û–¥–∏–Ω ffmpeg –ø—Ä–æ—Ü–µ—Å—Å
H265_PRESET=slower            # –ú–µ–¥–ª–µ–Ω–Ω—ã–π preset (–º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞)
H265_CRF=28                   # –í—ã—à–µ CRF = –º–µ–Ω—å—à–µ –±–∏—Ç—Ä–µ–π—Ç
```

### –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –≥—Ä–µ–µ—Ç—Å—è:

```bash
WORKER_CPU_LIMIT=1.0          # –ï—â–µ –º–µ–Ω—å—à–µ CPU
H265_PRESET=veryslow          # –°–∞–º—ã–π –º–µ–¥–ª–µ–Ω–Ω—ã–π preset
```

### –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏–µ —Ö–æ—Ä–æ—à–µ–µ):

```bash
WORKER_CPU_LIMIT=4            # –í—Å–µ —è–¥—Ä–∞
WORKER_MEMORY_LIMIT=8G
MAX_PARALLEL_JOBS=2
MAX_PARALLEL_FFMPEG=4
H265_PRESET=medium
H265_CRF=26
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å example
cp .env.example .env

# 2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ —Å–µ–±—è
nano .env

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose up -d

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker-compose ps
docker-compose logs -f worker
```

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞ –ª–µ—Ç—É

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ `.env`:

```bash
# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ worker
docker-compose up -d --force-recreate worker

# –ò–ª–∏ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose down
docker-compose up -d
```
